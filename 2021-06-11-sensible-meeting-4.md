# 2021-06-11 sensible-meeting (4/n)

## 旺仔 MetaSV 集成相关分享

#### 功能：

1. 签名器改动 （性能优化：更低延时；不带交易原文 rawhex 了）
2. FT 支持 （简化版 Sensible Query） 

#### 特点：

1. 接口精简；主要针对钱包用户，钱包用户；
2. 不做对浏览器支持（无聚合）
3. 跟蒋杰的接口各自独立演化，各有各的用处

- 目前状态：爬虫，数据结构，db 准备就绪，接口还没做（定义已做）；
- 时间预期：周六或周日开放；目前冯总钱包团队在配合联调

#### 问题交流：

冯总问：旺仔这边啥时候能接 TAAL mAPI？

（旺仔答：之前有不一致问题；性能不好，延迟几百毫秒，顾露：不一致可能 mAPI 1.3 已解决）

旺仔问：之前未确认交易存在 MetaSV 内存池跟蒋杰无法同步的情况，现在什么状态？

（耀欢答：现在是已经同步了）

顾露问：重爬数据性能如何？

（旺仔答：重爬数据从固定起始点一月份起，量不大，需要两个小时，滤掉常规交易，仅含合约交易）

冯总问：普通走普通 p2p；token 走 mAPI？

（旺仔答：没问题，xpub 已支持事后修复）

#### 旺仔：优化和问题解决

- 东京近期连接较慢影响签名器延时，所以做了一些优化（不带交易原文 rawhex）
- 蒋杰：负余额问题（旺仔：可以查一下 pipeline 这块，曾出过奇怪的问题）
- 旺仔提出：Sensible Query 服务目前对 utxo 无法鉴伪的（蒋杰确认：待解决，晚点补上）

---

#### 旺仔的其他评论

旺仔赞了 satoblocks 的实现（用到了里面识别交易的部分）；提了下我们的管理比较有效；肯定了我们是目前唯一可用的跨多个团队多个产品的方案~ (整体的共识又增强了)

旺仔说到目前光数据查询这块，MetaSV 和蒋杰的 Sensible Query 底层构造就是完全不同的两套实现（这还不算 Sensible Scan），最后用户在两边前端各自一查，发现行为是一致的，跑出来数据是一样的，没有什么不一致，是比较理想的状态 (我们最后都是以合约为准，不是以什么服务器为准)。

旺仔提到合约的实现考虑到了很多的情况，无状态的签名器目前来看也是很好的设计。

旺仔后续会发针对 MetaSV 对 Sensible 的支持和整合这块的文章。

---

## TAAL 的 mAPI 相关

### 介绍

- 1聪输出；0聪可能破坏已有逻辑 （直接干到 0 比较危险，可能没考虑过 0 的逻辑会挂）
- dust 可调；low dust 不知道有多 low，可以降成本
- 费率目前跟 TAAL 签的都是 0.25 sat/byte 

### 接入

- 顾露：蒋杰这边考虑开始接 TAAL 的 mAPI？ (蒋杰：没问题) 
- 旺仔：可以给 TAAL 之后同时发到内存池里，外面看到也会打包
- 顾露：如果TAAL mAPI 确认了，又 p2p 出去被别人打包会不会有问题 (旺仔：没问题)
- TAAL 后台记录有提交交易的情况，如果又总是外面打包了，可能影响不太好。(旺仔：mAPI 提交后，普通交易本身 TAAL 也会往外传播)

## 优化相关

1. 合约尺寸 scrypt 优化的部署情况 
    1. 已做未部署，测试 token 不管，后续用新版
    2. cc 已确认新的合约测试没有遇到问题
2. 签名器访问延迟优化
    1. cc: 前序和前前序算起来需要三次网络请求，应该集成成一个接口
    2. cc: 签名强制开启 gzip 压缩 (蒋杰：腾讯云函数不支持压缩，顾露：直接用 docker)
    3. 启动 200ms 休眠可以靠心跳避免（顾露：可通过最低负载的心跳包解决）
    4. 旺仔：签名费 CPU 资源 (蒋杰：每次签名 1ms)
3. 网络优化
    1. 先把上面能优化的全干到极致，再去针对网络做特定优化。
    2. 网络优化 1 ：在国内国外各自放足够多的签名器，不应该都在香港，应该内外相对均匀分布
    3. 网络优化 2 ：对签名器响应情况排序，总是向列表中低延迟的签名器发请求
    4. （具体方案顾露去跟各团队定，假如 7:4 的话 14 个，平局下来每个团队约 4 个，国内外各两个）
4. 测试
    1. 测一下 lambda 和云函数各自的签名成本
    2. 实测一下各地签名器的延迟情况（分别从国内/国外）
5. 部署相关
    1. lambda 百万请求内是免费的，部署成本极低 （内存 128MB）
    2. lambda 跨地域需要配；腾讯云跨地域也可以直接复制 （旺仔：可能可以更加自动化）

## 签名器默认公钥数量

- 在 5:3 和 7:4 里面
    - 选延迟区别是否大：实际上瓶颈在上传带宽
    - 新版合约尺寸：5:3 (4.9KB) 还是 7:4 (5.1KB)
- 顾露：不要给延迟高的签名器发（排序）这样提高了响应，也省了上行带宽
- 福强：要足够分散
- cc: 注意签名器私钥保管问题

## SensibleScan 浏览器进展

- 蒋杰：聚合这块还没有提供接口（还没有设计好，需求比较麻烦，吃性能，没有想匆忙去做，需要想清楚再动手，不然后面一变就得重写了）
- 飞龙：聚合功能可以先放放，查单个交易和单个地址的余额才是重点，才是紧迫的，是不是可以优先处理？
- 顾露：确实更关心单个数据，汇总数据先都填成 0 问题不大。我们一直以来的建议都是先做已有已经支持的功能，聚合等已有的完善后再提供
- 冯总：Sensible Scan 先不做聚合能实现能行吗？
- 王宇：之前的计划是 Sensible Scan 主要都是聚合，单个交易直接跳蒋杰
- 顾露：在蒋杰网站外面需要套个用户友好的产品化的壳（蒋杰：Sensible Query不是静态页面，都是依赖后端接口的，前端是 vue 的纯前端，可以换）
- 冯总：数据有接口吗？（蒋杰：全部都有接口）
- 冯总：那为啥外头还要套个壳呢？（蒋杰：因为页面是自己设计的，前面飞龙也说对用户不是很友好）
- 蒋杰：我们需要一个看起来产品化的浏览器，原有的 vue 实现的可以作为调试用的对照浏览器
- 顾露：不要 copy，fork 出去改（冯总：东西在吗？顾露：都在 GitHub 开放的，蒋杰：3个组件，有文档讲部署这块，golang 实现）最好是分析区块和内存池这个代码还是蒋杰维护，前端可以替换产品化部分（蒋杰：我也认为应该这样，建议王宇先了解 web server 这块，另外两个后端守护进程可以先不要动）这样双方边界明显，出了 bug 找人都好找，沟通成本低。
- 蒋杰：建议重构先从重构 vue js 这块开始（顾露：维护一段时间消化吸收就可以整个接过去了，现阶段还是明确责任人比较好）
- 冯总：没问题，可以这样。（下周回来后加快 SensibleScan 的开发）

## 正常议题结束后的问题讨论

#### 冯总反馈

- dust 费率讨论
    - 顾露：TAAL 允许改，不过还只是测试阶段
    - 这在合约之外，是属于调优的范围，不影响发布
- genesis 能不能把签名器地址带上
    - 顾露：能，做成推荐的可选项

#### 王福强 testnet 遇到的问题

- 王福强：testnet 创建和转账会失败？广播成功，获取交易失败，查不到；
- 蒋杰：总是重现还是偶尔遇到？（偶尔）有时可能在更新和部署，不应该总是出现
- 蒋杰和 cc 都测过，测试网的 token 相关操作本身是通的（没有潜规则）
- 小结：大家碰到问题一定要及时在群里说，不然过很久再说上下文已经丢失了，很难分析了

#### 喂价 oracle

- 王福强：喂价 oracle 搞一下把，这个很基础，没什么难度
- 顾露：之前东澳岛时聊过，可以安排搞。有成熟的话直接抄一个。(用 chainlink 结合自己的方法加快频率) 回头找王福强聊细节

### 其他小问题

- 耀欢：转账 utxo 不能超过3个，改不改？
- cc: 可以改大，但没法避免群里说的问题
- 耀欢：钱包合并 utxo 才能转账，在 sdk 做不太适合，在钱包做比较麻烦
- cc: 合约做不了 (终归不是无上限的，钱包始终要考虑)
- 顾露：按 cc 说的保持现状即可

-----

- cc：精度问题蒋杰改吗？
- 蒋杰：余额查看接口还没改 (钱包需要)  int64 转浮点数会出问题
- 旺仔：为啥转浮点数？不需要转
- cc: http 返回时用 string 就行，不要用 json 本身的 number

-----

- 福强：改 7:4 啥时候升级？
- 顾露：因为冯总下周，我们需要尽快配合~
- 福强：好的

-----

- 耀欢：广播走 mAPI 就得全走 mAPI 需要各方都同步内存池
- 顾露：mAPI 这个蒋杰这边先把功能做了，但第一版要不要用可以先不用一步到位
- 耀欢：是的，后续连通性可能还要一起测

-----

- cc : show 这边下周上正式？（王宇：是的）那要赶紧测下 release 版合约 (王宇：ok) 只有我自己测过
- 耀欢：好的，sdk 合约更新还需要等蒋杰这边不？nft 重构还要改不？
- 顾露：这次 nft 重构不上了

----

PS: 会议严重超时，原定 45min 实际 100min

(完)  
2021-06-12
